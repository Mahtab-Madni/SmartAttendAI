<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mark Attendance - SmartAttendAI</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --primary-color: #4361ee;
        --secondary-color: #3a0ca3;
        --success-color: #06d6a0;
        --danger-color: #ef476f;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding-top: 70px;
      }

      .navbar {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .main-content {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 30px;
        margin: 20px auto;
        max-width: 800px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .video-container {
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
        position: relative;
      }

      #video {
        width: 100%;
        height: auto;
        display: block;
      }

      #canvas {
        display: none;
      }

      .controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin: 20px 0;
      }

      .btn-custom {
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
      }

      .btn-primary-custom {
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
        border: none;
        color: white;
      }

      .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
      }

      .btn-success-custom {
        background: linear-gradient(45deg, var(--success-color), #059669);
        border: none;
        color: white;
      }

      .btn-success-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(6, 214, 160, 0.3);
      }

      .status-display {
        background: rgba(255, 255, 255, 0.8);
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 4px solid var(--primary-color);
      }

      .classroom-selector {
        margin: 20px 0;
      }

      .form-select {
        border-radius: 10px;
        padding: 12px;
        border: 2px solid #e1e5e9;
      }

      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">
          <i class="bi bi-shield-check"></i> SmartAttendAI
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/mark-attendance"
                >Mark Attendance</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/dashboard">Dashboard</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      <div class="main-content">
        <h2 class="text-center mb-4">
          <i class="bi bi-camera-video"></i> Mark Attendance
        </h2>

        <!-- Classroom Selection -->
        <div class="classroom-selector">
          <label for="classroomSelect" class="form-label fw-bold"
            >Select Classroom:</label
          >
          <select class="form-select" id="classroomSelect">
            <option value="">Choose a classroom...</option>
            {% for classroom in classrooms %}
            <option value="{{ classroom }}">{{ classroom }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Video Container -->
        <div class="video-container">
          <video id="video" autoplay muted></video>
          <canvas id="canvas"></canvas>
        </div>

        <!-- Controls -->
        <div class="controls">
          <button id="startCamera" class="btn btn-primary-custom btn-custom">
            <i class="bi bi-camera-video"></i> Start Camera
          </button>
          <button
            id="markAttendance"
            class="btn btn-success-custom btn-custom"
            disabled
          >
            <i class="bi bi-check-circle"></i> Mark Attendance
          </button>
          <button id="stopCamera" class="btn btn-secondary btn-custom" disabled>
            <i class="bi bi-camera-video-off"></i> Stop Camera
          </button>
        </div>

        <!-- Status Display -->
        <div class="status-display">
          <h5><i class="bi bi-info-circle"></i> Status</h5>
          <div id="statusMessage">
            Select a classroom and start the camera to begin.
          </div>
        </div>

        <!-- Instructions -->
        <div class="alert alert-info">
          <h6><i class="bi bi-lightbulb"></i> Instructions:</h6>
          <ul class="mb-0">
            <li>Select your classroom from the dropdown</li>
            <li>Click "Start Camera" to activate facial recognition</li>
            <li>
              Look directly at the camera and follow liveness detection prompts
            </li>
            <li>Click "Mark Attendance" when your face is recognized</li>
          </ul>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let video = document.getElementById("video");
      let canvas = document.getElementById("canvas");
      let ctx = canvas.getContext("2d");
      let stream = null;
      let websocket = null;

      const startCameraBtn = document.getElementById("startCamera");
      const markAttendanceBtn = document.getElementById("markAttendance");
      const stopCameraBtn = document.getElementById("stopCamera");
      const statusMessage = document.getElementById("statusMessage");
      const classroomSelect = document.getElementById("classroomSelect");

      // Start Camera
      startCameraBtn.addEventListener("click", async () => {
        try {
          if (!classroomSelect.value) {
            alert("Please select a classroom first!");
            return;
          }

          stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480 },
          });
          video.srcObject = stream;

          startCameraBtn.disabled = true;
          markAttendanceBtn.disabled = false;
          stopCameraBtn.disabled = false;

          statusMessage.innerHTML =
            '<span class="text-success">Camera started. Ready for attendance marking.</span>';

          // Start WebSocket connection for real-time processing
          connectWebSocket();
        } catch (error) {
          console.error("Error starting camera:", error);
          statusMessage.innerHTML =
            '<span class="text-danger">Error starting camera. Please check permissions.</span>';
        }
      });

      // Stop Camera
      stopCameraBtn.addEventListener("click", () => {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          video.srcObject = null;
        }

        if (websocket) {
          websocket.close();
        }

        startCameraBtn.disabled = false;
        markAttendanceBtn.disabled = true;
        stopCameraBtn.disabled = true;

        statusMessage.innerHTML =
          "Camera stopped. Select classroom to restart.";
      });

      // Mark Attendance
      markAttendanceBtn.addEventListener("click", async () => {
        try {
          if (!classroomSelect.value) {
            alert("Please select a classroom!");
            return;
          }

          // Capture frame from video
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);

          const imageData = canvas.toDataURL("image/jpeg", 0.8);
          const base64Data = imageData.split(",")[1];

          // Get location if available
          let location = null;
          if (navigator.geolocation) {
            location = await new Promise((resolve) => {
              navigator.geolocation.getCurrentPosition(
                (position) =>
                  resolve({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                  }),
                () => resolve(null),
              );
            });
          }

          // Send attendance request
          const response = await fetch("/api/attendance/mark", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              image_data: base64Data,
              classroom: classroomSelect.value,
              location: location,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            statusMessage.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> ${result.message}</span>`;
          } else {
            statusMessage.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${result.message}</span>`;
          }
        } catch (error) {
          console.error("Error marking attendance:", error);
          statusMessage.innerHTML =
            '<span class="text-danger">Error marking attendance. Please try again.</span>';
        }
      });

      // WebSocket connection for real-time updates
      function connectWebSocket() {
        const wsUrl = `ws://localhost:8000/ws/attendance`;
        websocket = new WebSocket(wsUrl);

        websocket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === "face_detected") {
            statusMessage.innerHTML = `<span class="text-info"><i class="bi bi-person-check"></i> Face detected: ${data.confidence}% confidence</span>`;
          } else if (data.type === "liveness_check") {
            statusMessage.innerHTML = `<span class="text-warning"><i class="bi bi-eye"></i> ${data.message}</span>`;
          }
        };

        websocket.onerror = (error) => {
          console.error("WebSocket error:", error);
        };
      }
    </script>
  </body>
</html>
