# PostgreSQL Setup for Railway Deployment

## Why Use PostgreSQL?

âœ… **Persistent data** - Survives redeployment  
âœ… **Better concurrency** - Multiple users at once  
âœ… **Production-ready** - Recommended for live apps  
âœ… **Easy on Railway** - One-click setup

---

## Step 1: Add PostgreSQL to Railway Project

### Method A: Railway Dashboard (Easiest)

1. **Open your Railway project**
   - Go to [https://railway.app/dashboard](https://railway.app/dashboard)
   - Click on your SmartAttendAI project

2. **Add PostgreSQL Database**
   - Click **"New"** button (top right)
   - Select **"Database"** â†’ **"PostgreSQL"**
   - Railway creates PostgreSQL automatically
   - **Wait 1-2 minutes** for initialization

3. **Find Your Database URL**
   - Click **"PostgreSQL"** service in your project
   - Go to **"Variables"** tab
   - Copy the **`DATABASE_URL`** variable
   - It looks like: `postgresql://user:password@host:port/database`

### Method B: Using Railway CLI

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Add PostgreSQL
railway add

# Select PostgreSQL from the menu
# It will auto-configure DATABASE_URL
```

---

## Step 2: Update Your Railway Variables

### In Railway Dashboard:

1. **Go to your SmartAttendAI service** (the Python app)
2. **Go to "Variables" tab**
3. **Add/Update these variables:**

```
DATABASE_TYPE=postgresql
DATABASE_URL=[COPY FROM PostgreSQL SERVICE VARIABLES]
DEBUG=False
ENVIRONMENT=production
TELEGRAM_BOT_TOKEN=your_bot_token
SECRET_KEY=your-secret-key-here
```

### Important:

- **Do NOT modify** `DATABASE_URL` - it's auto-generated by Railway
- Simply **copy it** from the PostgreSQL service Variables tab

---

## Step 3: Verify Updated Files

These files are already updated for PostgreSQL:

âœ… **requirements.txt** - Added `psycopg2-binary` (PostgreSQL driver)  
âœ… **.env.example** - Shows PostgreSQL configuration  
âœ… **Dockerfile** - Compatible with PostgreSQL

---

## Step 4: Test PostgreSQL Connection

### Local Testing (Optional)

If you want to test PostgreSQL locally first:

```bash
# Install PostgreSQL locally
# Windows: https://www.postgresql.org/download/windows/
# Mac: brew install postgresql
# Linux: apt-get install postgresql

# Create .env file with your local PostgreSQL
cp .env.example .env

# Edit .env:
# DATABASE_TYPE=postgresql
# DATABASE_URL=postgresql://postgres:password@localhost:5432/smartattend

# Test connection
python -c "from config.settings import DATABASE_CONFIG; print(DATABASE_CONFIG)"
```

### On Railway After Deploy

1. **Wait for deployment to complete** (watch Logs tab)
2. **Check Logs for errors:**
   ```
   railway logs -f
   ```
3. **Look for these messages:**
   - âœ… "Database connected successfully"
   - âœ… "Creating tables..."
   - âŒ If error: Check DATABASE_URL in Variables

---

## Step 5: Initialize Database Tables

The app auto-creates tables on first run. If you need to manually initialize:

### Via Python Script

```bash
# SSH into Railway container
railway shell

# Run database initialization
python -c "
from src.utils.database import AttendanceDatabase
from config.settings import DATABASE_CONFIG
db = AttendanceDatabase()
print('Database tables created successfully!')
"
```

### Using Alembic (Advanced)

```bash
# Generate migration
alembic revision --autogenerate -m "Initial migration"

# Apply migrations
alembic upgrade head
```

---

## Configuration in config/settings.py

Your app already supports this, but here's what's happening:

```python
DATABASE_CONFIG = {
    "TYPE": "sqlite",  # or "postgresql"
    "SQLITE_PATH": DATA_DIR / "smartattend.db",
    "FIREBASE_CREDS": BASE_DIR / "config" / "firebase-credentials.json",
}
```

**The app automatically detects** `DATABASE_TYPE` from `.env` and uses PostgreSQL if set to `postgresql`.

---

## Step 6: Redeploy with PostgreSQL

### Automatic Redeploy

```bash
git add .env.example requirements.txt
git commit -m "Add PostgreSQL support"
git push origin main
# Railway auto-deploys
```

### Manual Redeploy on Railway

1. Go to Railway dashboard
2. Click your SmartAttendAI service
3. Click **"Deploy"** tab
4. Click **"Redeploy"** button

---

## Troubleshooting PostgreSQL

### Error: "psycopg2: FATAL: password authentication failed"

**Solution:**

- Copy the EXACT `DATABASE_URL` from PostgreSQL service
- Don't edit the URL manually
- Check no typos in Variables

### Error: "relation does not exist"

**Solution:**

- Database tables weren't created
- Run initialization script above
- Or restart the app (Rails will auto-create)

### Error: "could not translate host name to address"

**Solution:**

- Wait 2-3 minutes for PostgreSQL to fully initialize
- Check PostgreSQL service status is "Running" (green)
- Redeploy your app

### Connection Timeout

**Solution:**

- PostgreSQL service might be sleeping (free tier)
- Upgrade to standard plan for 24/7 uptime
- Or click PostgreSQL service to wake it up

---

## Backup Your Data (Important!)

Railway provides automatic backups, but you can also:

### Export Data from PostgreSQL

```bash
# Connect to Railway PostgreSQL
railway shell

# Backup database
pg_dump $DATABASE_URL > smartattend_backup.sql

# Restore from backup
psql $DATABASE_URL < smartattend_backup.sql
```

### Set Automatic Backups

1. In Railway â†’ PostgreSQL service
2. Go to "Settings"
3. Enable "Automated Backups"

---

## Performance Tips

1. **Use PostgreSQL** for production âœ…
2. **Monitor database size** on Railway dashboard
3. **Add indexes** on frequently queried columns:
   ```sql
   CREATE INDEX idx_attendance_student ON attendance(student_id);
   CREATE INDEX idx_attendance_date ON attendance(date);
   ```
4. **Use connection pooling** (Railway handles this)

---

## Switch Back to SQLite (If Needed)

If you want to revert to SQLite:

1. **Update Variables on Railway:**
   - Remove `DATABASE_URL`
   - Set `DATABASE_TYPE=sqlite`

2. **Redeploy**

3. **Data will reset** (SQLite is ephemeral on Railway)

---

## Complete Setup Checklist

- [ ] PostgreSQL plugin added to Railway
- [ ] `DATABASE_URL` copied from PostgreSQL Variables
- [ ] `DATABASE_TYPE=postgresql` in Variables
- [ ] Other variables (TELEGRAM_BOT_TOKEN, etc.) added
- [ ] Dockerfile builds successfully
- [ ] App deployment shows "Success"
- [ ] Logs show database connection working
- [ ] Face attendance features work on deployed app
- [ ] Data persists after redeployment

---

## Next Steps

1. âœ… **Deploy** with PostgreSQL
2. Test face recognition, geofencing, emotion detection
3. **Set up automated backups** in PostgreSQL settings
4. Monitor via Railway dashboard
5. Scale resources if needed

---

## Need Help?

- **PostgreSQL Issues**: Check Railway logs (`railway logs -f`)
- **Connection Strings**: See [PostgreSQL Connection URI](https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING)
- **Railway Docs**: https://docs.railway.app/databases/postgresql

---

**You're ready to deploy with PostgreSQL!** ðŸš€
